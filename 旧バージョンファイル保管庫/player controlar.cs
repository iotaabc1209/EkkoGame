using UnityEngine; public class PlayerController : MonoBehaviour { public float speed = 5f; public float jumpForce = 7f; public float groundCheckDistance = 2f; public float coyoteTime = 0.1f; public float jumpBufferTime = 0.1f; float lastGroundedTime; float lastJumpInputTime; public LayerMask groundLayer; Rigidbody2D rb; void Start() { rb = GetComponent<Rigidbody2D>(); // ★ 無効な初期値 lastGroundedTime = -999f; lastJumpInputTime = -999f; //初期状態が地面ならコヨーテタイムのため記録しておく if (CheckGrounded()) { lastGroundedTime = Time.time; } } void Update() { float move = Input.GetAxis("Horizontal"); rb.linearVelocity = new Vector2(move * speed, rb.linearVelocity.y); bool isGrounded = CheckGrounded(); // 地面にいるなら「最後に地面にいた時刻」を更新 if (isGrounded) { lastGroundedTime = Time.time; } // コヨーテタイム判定 bool canJump = isGrounded || (Time.time - lastGroundedTime <= coyoteTime); //ジャンプバッファーのため入力を記録 if (Input.GetButtonDown("Jump")) { lastJumpInputTime = Time.time; } // 入力バッファ判定 bool hasBufferedJump = Time.time - lastJumpInputTime <= jumpBufferTime; //実行条件 if (hasBufferedJump && canJump) { rb.linearVelocity = new Vector2(rb.linearVelocity.x, jumpForce); lastGroundedTime = -999f; lastJumpInputTime = -999f; } Debug.Log(isGrounded); } bool CheckGrounded() { BoxCollider2D col = GetComponent<BoxCollider2D>(); float rayLength = 0.1f; float inset = 0.05f; // 端から少し内側 float y = col.bounds.min.y; Vector2 center = new Vector2(col.bounds.center.x, y); Vector2 left = new Vector2(col.bounds.min.x + inset, y); Vector2 right = new Vector2(col.bounds.max.x - inset, y); bool hitCenter = Physics2D.Raycast(center, Vector2.down, rayLength, groundLayer); bool hitLeft = Physics2D.Raycast(left, Vector2.down, rayLength, groundLayer); bool hitRight = Physics2D.Raycast(right, Vector2.down, rayLength, groundLayer); // 可視化（Sceneビューで確認） Debug.DrawRay(center, Vector2.down * rayLength, Color.red); Debug.DrawRay(left, Vector2.down * rayLength, Color.red); Debug.DrawRay(right, Vector2.down * rayLength, Color.red); return hitCenter || hitLeft || hitRight; } } using UnityEngine; public class PlayerController : MonoBehaviour { public float speed = 5f; public float jumpForce = 7f; public float groundCheckDistance = 2f; public float coyoteTime = 0.1f; public float jumpBufferTime = 0.1f; float lastGroundedTime; float lastJumpInputTime; public LayerMask groundLayer; Rigidbody2D rb; void Start() { rb = GetComponent<Rigidbody2D>(); // ★ 無効な初期値 lastGroundedTime = -999f; lastJumpInputTime = -999f; //初期状態が地面ならコヨーテタイムのため記録しておく if (CheckGrounded()) { lastGroundedTime = Time.time; } } void Update() { float move = Input.GetAxis("Horizontal"); rb.linearVelocity = new Vector2(move * speed, rb.linearVelocity.y); bool isGrounded = CheckGrounded(); // 地面にいるなら「最後に地面にいた時刻」を更新 if (isGrounded) { lastGroundedTime = Time.time; } // コヨーテタイム判定 bool canJump = isGrounded || (Time.time - lastGroundedTime <= coyoteTime); //ジャンプバッファーのため入力を記録 if (Input.GetButtonDown("Jump")) { lastJumpInputTime = Time.time; } // 入力バッファ判定 bool hasBufferedJump = Time.time - lastJumpInputTime <= jumpBufferTime; //実行条件 if (hasBufferedJump && canJump) { rb.linearVelocity = new Vector2(rb.linearVelocity.x, jumpForce); lastGroundedTime = -999f; lastJumpInputTime = -999f; } Debug.Log(isGrounded); } bool CheckGrounded() { BoxCollider2D col = GetComponent<BoxCollider2D>(); float rayLength = 0.1f; float inset = 0.05f; // 端から少し内側 float y = col.bounds.min.y; Vector2 center = new Vector2(col.bounds.center.x, y); Vector2 left = new Vector2(col.bounds.min.x + inset, y); Vector2 right = new Vector2(col.bounds.max.x - inset, y); bool hitCenter = Physics2D.Raycast(center, Vector2.down, rayLength, groundLayer); bool hitLeft = Physics2D.Raycast(left, Vector2.down, rayLength, groundLayer); bool hitRight = Physics2D.Raycast(right, Vector2.down, rayLength, groundLayer); // 可視化（Sceneビューで確認） Debug.DrawRay(center, Vector2.down * rayLength, Color.red); Debug.DrawRay(left, Vector2.down * rayLength, Color.red); Debug.DrawRay(right, Vector2.down * rayLength, Color.red); return hitCenter || hitLeft || hitRight; } }